import asyncio
import random
from datetime import datetime
from typing import Optional, Tuple, Union

import pyrogram


class Argument:
    def __init__(self, client):
        self.client: pyrogram.Client = client

    def getMention(
        self,
        user: pyrogram.types.User,
        logs: bool = False,
        no_tag: bool = False,
        tag_and_id: bool = False,
    ) -> str:

        name = user.first_name
        if user.last_name:
            name += f" {user.last_name}"

        if logs:
            return f"{name} ({user.id})"
        if no_tag:
            return name

        link = f"tg://user?id={user.id}"
        mention = f"<a href='{link}'>{name}</a>"
        if tag_and_id:
            mention += f" | <code>{user.id}</code>"

        return mention

    async def getNamebot(self, bot_token: str) -> dict:
        temp_bot_client = pyrogram.Client(
            name="temp_bot_name_fetcher",
            api_id=self.client.api_id,
            api_hash=self.client.api_hash,
            bot_token=bot_token,
            in_memory=True,
        )
        try:
            async with temp_bot_client:
                return await temp_bot_client.get_me()
        except Exception:
            return "Bot token invalid"

    def getMessage(
        self,
        message: pyrogram.types.Message,
        is_arg: bool = False,
        is_tuple: bool = False,
    ) -> Union[str, pyrogram.types.Message, Tuple[Optional[str], Optional[str]]]:

        text_content = message.text or message.caption or ""
        command_parts = message.command or text_content.split()
        replied = message.reply_to_message

        replied_text = ""
        if replied:
            replied_text = (replied.text or replied.caption).html if (replied.text or replied.caption) else ""

        quote_text = ""
        if hasattr(message, "quote") and message.quote:
            quote_text = message.quote.text or ""

        if is_tuple:
            part1 = command_parts[1] if len(command_parts) > 1 else None
            part2 = " ".join(command_parts[2:]) if len(command_parts) > 2 else (replied_text or quote_text or None)
            return part1, part2

        if is_arg:
            if quote_text:
                return quote_text
            if len(command_parts) > 1:
                return text_content.split(None, 1)[1]
            if replied and replied_text:
                return replied_text
            return ""

        if replied:
            return replied
        if len(command_parts) > 1:
            return text_content.split(None, 1)[1]

        return ""

    async def getReasonAndId(
        self, message: pyrogram.types.Message, sender_chat: bool = False
    ) -> Tuple[Optional[int], Optional[str]]:

        args = (message.text or "").strip().split()
        replied = message.reply_to_message
        target_id = None
        reason = None

        if replied:
            if replied.from_user:
                target_id = replied.from_user.id
            elif sender_chat and replied.sender_chat:
                target_id = replied.sender_chat.id

            if len(args) > 1:
                reason = " ".join(args[1:])

        elif len(args) > 1:
            try:
                target_user = await self.client.get_users(args[1])
                target_id = target_user.id
                if len(args) > 2:
                    reason = " ".join(args[2:])
            except Exception:
                return None, None

        return target_id, reason

    async def getAdmin(self, message: pyrogram.types.Message) -> bool:
        try:
            member = await self.client.get_chat_member(message.chat.id, message.from_user.id)
            return member.status in (
                pyrogram.enums.ChatMemberStatus.ADMINISTRATOR,
                pyrogram.enums.ChatMemberStatus.OWNER,
            )
        except Exception:
            return False

    async def getId(self, message: pyrogram.types.Message) -> Optional[int]:
        user_id, _ = await self.getReasonAndId(message, sender_chat=True)
        return user_id

    async def copyMessage(self, chatId: int, msgId: int, chatTarget: int):
        try:
            await self.client.copy_message(chatTarget, chatId, msgId)
            await asyncio.sleep(1)
        except Exception:
            pass

    async def ping(self) -> float:
        start = datetime.now()
        await self.client.invoke(pyrogram.raw.functions.Ping(ping_id=0))
        end = datetime.now()
        delta_ping = (end - start).microseconds / 1000
        return delta_ping

    def randomEffect(self, is_premium: bool = False) -> int:
        if not is_premium:
            list_id_effect = [
                5107584321108051014,
                5104858069142078462,
                5159385139981059251,
                5104841245755180586,
                5046509860389126442,
                5046589136895476101,
            ]
        elif is_premium:
            list_id_effect = [
                5170169077011841524,
                5170166362592510656,
                5048771083361059460,
                5170257231215591956,
                5158936234294248618,
                4967494041374556629,
                5170149264327704981,
                5046551865169281494,
                5161554034041029689,
                5125503964049048317,
                5066712811023894584,
                5066947642655769508,
                5095856784057303751,
                4988252812317033130,
                4988134357119009237,
                4927250902185673331,
                5066779159678682060,
                5075655057488217321,
                5066576334143095943,
                4961155507164283482,
                4961017943656759969,
                4962976753686414048,
                5066993302453093673,
                5123236135417415011,
                5123233223429587601,
                5123046001510188023,
                5123265598893064880,
                5122846324185629167,
                5066978240002786236,
                4961016393173566021,
                4961122255527478034,
                4963232093787128618,
                4961092903720977544,
                4960944078809203417,
                5109477370893435421,
                5069111056337470630,
                5107633812016202563,
                5107144215809229474,
                5107153978269893301,
                5107400329004058326,
                5107491876231971605,
                4913625371842183765,
                4913435779100836551,
                4913510691920413388,
                4916165059018752691,
                4913460264709391187,
                4913445953878360935,
                4913930782671635058,
                4990285736302346915,
                5066610182780355771,
                4989997728680380153,
                5003596415478268711,
                5006239241999483552,
                5006084210859967333,
                5006150512270115734,
                5089139004234793667,
                5089358816366035753,
                5089416218603946547,
                5159305906424382943,
                5089598484131087029,
                5089447945527362129,
                4925230459375322151,
                4927184970142712981,
                5068838802655544199,
                5069188799540495289,
                5066849184825475891,
                4925068178331010095,
                5127791914602463817,
                5071394291016795490,
                5087137729863484424,
                5067074180982244082,
                5089460564141278042,
                5066795381770158548,
                5134366251107222485,
                5044101728060834560,
                5046284769743077765,
                5041819580008236993,
                5089131707085358138,
                5091878604959122376,
                5071259338849387492,
                5089234812070265877,
                5089422278802801345,
                5026104105693611449,
                5026437541184668623,
                4965608262968804599,
                5026421185949205937,
                5121096477199827757,
                5125520873335292348,
                5089434807222403861,
                5089216884876772391,
                5026494110198924646,
                5091606991227323336,
                4965357582907606094,
                5089524022283076814,
                5089594618660520655,
                5041854420782941263,
                5055413967543861653,
                5055664432856695007,
                5026331292283700185,
                5071299733016806207,
                5086991627960976320,
                5071309894909428639,
                5066635132245378011,
                5091342528616072685,
                5120906893048415743,
                5089343350188802996,
                5120948558526153760,
                5026486074315113392,
                5136788470928245857,
                5068809425079239498,
                5091663800759747631,
                5089613774214660825,
                5026435775953109827,
                4967721189309940952,
                5089178556588622814,
                5091705285848859672,
                5440802804648131487,
                5449793090321665071,
                5229113465880198444,
                5204257609669942785,
                5298813045563201938,
                5312098066604504779,
                5350288151296350691,
                5285154392431925129,
                5287781207315078357,
                5201744267822767308,
                5332716319101963344,
                5461008705925429632,
                5384193525074112686,
                5276162088123767055,
                5350399176200952969,
                5287288621810857823,
                5285142572681928064,
                5199964235806808385,
                5418029475000500877,
                5264848173603494889,
                5278688898988396674,
                5280502418864364941,
                5370977932179161211,
                5453974842279743084,
                5454219397717579175,
                5197595780386415999,
                5451712008695073016,
                5407120103449842634,
                5402160120597595491,
                5237995080291207428,
                5274004129050546755,
                5352663577448698346,
                5233450571100345621,
                5393224904994738875,
                5400116231560780632,
                5242471217897691488,
                5343738579573039183,
                5319095899769556468,
                5474553821596244457,
                5449385072723517170,
                5386460112460210613,
                5215171091504319975,
                5244583564418241559,
                5436072280423682305,
                5005992964279763916,
                5391345977061822285,
                5276194729875217464,
                4911386156282675749,
                5274264700421413486,
                5309811052353959795,
                5330116712836642577,
                5235577524804664467,
                5199595396900330332,
                4911541397875589667,
                5265002324274726737,
                5199725328250969763,
                5226506618300013474,
                5272010757419047798,
                5467738889613490137,
                5330377864028109649,
                5343737583140620461,
                5400083151722659509,
                5233410992976710895,
                5269395453048265045,
                5303263761258271050,
                5449765774329663898,
                5265228261029327858,
                5296669762393217791,
                5301147038166045393,
                5228729693372438887,
                5353078329555571789,
                5438619054296287587,
                5278548517982327354,
                5402207579986219491,
                5454024994612861657,
                5188230385154149088,
                5467793998338872715,
                5197604215702183380,
                5381830270859104119,
                5199437561147185833,
                5298798245105916829,
                5242687482385947054,
                5271900157716221502,
                5237935702368342717,
                5447655601062561933,
                5213420806431853909,
                5226433260258612177,
                5228705087504796233,
                5393431772094551961,
                5188598734434365507,
                5406864625910176081,
                5413443781368239985,
                5359400791998224519,
                5296379100481476100,
                5296795102423816510,
                5294039833658803832,
                5440471112913804372,
                5296469350629264898,
                5215274136359688514,
                5251246888350398100,
                5237912737178206592,
                5199582731041773705,
                5355022480861848696,
                5418054291321538483,
                5402177476560434979,
                5343739013364729462,
                5285410247928726633,
                5377476093143957015,
                5458649175447068117,
                5296789312807901666,
                5274189087522178220,
                5357427782806680828,
                5192811251243179335,
                5273953250867955597,
                5422822731517283238,
                5447129368784553154,
                5258138266456045276,
                5305638199568123955,
                5456260417716243300,
                5199750359320370821,
                5204326728578649609,
                5287739803830327916,
                5240007783570486716,
                5386436610399160058,
                5199907928785557571,
                5404624847709943130,
                5208571517771723025,
                5411406717034448891,
                5298766204649872471,
                4970183764643676852,
                5202172110989957559,
                5335006395664179964,
                5377425485544311706,
                5276244100524283683,
                5309974729262642571,
                5399979303708410516,
                5373136032986316091,
                5427385455664448590,
                5197248197273078492,
                5377426593645880390,
                5278525600036823830,
                5429481068992404622,
                5199501195382627206,
                5474623339936895299,
                5402152698894109903,
                5386831648606141666,
                5237736742303321114,
                5267111900541367075,
                5276411063082960926,
                5458920707574480084,
                5292129900356966544,
                5397830067713754992,
                5276499466394811467,
                5307532739707158053,
                5199751145299383550,
                5474525680970525814,
                5325995584341940846,
                5267353844639078745,
                5278632540427537535,
                5355055934362107020,
                5258502780330460137,
                5422665269426265106,
                5255906459715115520,
                5237839791453655371,
                5278479154260495753,
                5316818540605478829,
                5199645609362987873,
                5298765568994712160,
                5402332018073679834,
                5318898808015296420,
                5305402341439058363,
                5269524864707860078,
                5319158979954229182,
                5364187558819418305,
                5431832168449983046,
                5436219821140220621,
                5294381378048113427,
                5433677406659419467,
                5287700225706705481,
                5309985054364021277,
                5003540413399696306,
                5321047026102714339,
                5283179205691990448,
                5343923593879240259,
                5422525270672284142,
                5316683262020564796,
                5370875879461250062,
                5215558330050699073,
                5233643483851411432,
                5215451999545348731,
                5226639740811365578,
                5418213501464234089,
                5298524445235748201,
                5406757183008291910,
                5265266189885512685,
                5199914190847874664,
                5199654620204373613,
                5282786564076739562,
                5276296250017193032,
                5226749537355320995,
                5199797767169382536,
                5400247588840554648,
                5199616051398055853,
                4992272626828182669,
                5271819223352489647,
                5285202242662583987,
                5276130773517213254,
                5465392617699160564,
                5318885888753677407,
                5190483263004620832,
                5260273183029744498,
                4985671579921811347,
                5235959441886557740,
                5210972967130912095,
                5343563881778267878,
                5465428884403016135,
                5222256511937433879,
                5278278115431305575,
                5217544915633838343,
                5199710725362162922,
                5325508169978368119,
                5213075100219231383,
                5316559463883227154,
                5289497025274985738,
                5377817847986675057,
                5269383014822975158,
                5296271447126186407,
                5339081233001362284,
                5215623415985085036,
                5460747722237687710,
                5379735387675575132,
                5373254191831594037,
                5469784788695005955,
                5440726014927844546,
                5222344073435692012,
                5384200354072117254,
                5409367492332115297,
                5361877497774358112,
                5386766008620959057,
                5202214596806450391,
                5350590130446932583,
                5314671589533431402,
                5199736001244699098,
                5201972416485529451,
                5203995831413268540,
                5280689245646770785,
                5334882116490510602,
                5276270733616487427,
                5300918331157519266,
                5202206840095511405,
                5271825352270814879,
                5269257464338979611,
                5258204473376919605,
                5386728797024304133,
                5386366834360467867,
                5204239716836186750,
                5384149007738099175,
                5314551180125281802,
                5255931830086944741,
                5393068868832879749,
                5386309526611834845,
                5303197064711123020,
                5413420141868228037,
                5282751684647339553,
                5278314803041933798,
                5258019592214694954,
                5298993008987872222,
                5402617139477630460,
                5325838272574800390,
                5325732229832260838,
                5345783735625194276,
                5280886157012395432,
                5287245697907695575,
                5291931816465275738,
                5199474012534610002,
                5364136680636828335,
                5199843671779843451,
                5199465598693687055,
                5312543115410681520,
                5382211990372497138,
                5451910114061602411,
                5265153872195756001,
                5192784725525152419,
                5402217741878838912,
                5271837150545976153,
                5467812050086416198,
                5211213609853534583,
                5224269103547567373,
                5271662577305277261,
                5436014903955561968,
                5276496378313329689,
                5307875387903067038,
                5310027626079870721,
                5426962328371349800,
                5469657369900235439,
                5208428005734498711,
                5222238451599949657,
                5228895582189272633,
                5427200132120582645,
                5663393367413751912,
                5668144954157826053,
                5420104476780411731,
                5717331924653965329,
                5537250070556049427,
                5638930797063831568,
                5648025729615527962,
                5215616105950759174,
                5735664292477272080,
                5722065266376966148,
                5717812776307523611,
                5544057378971844622,
                5496953669477728274,
                5724617928649736201,
                5519457717560803344,
                5544282014351360004,
                5758269066133372941,
                5701820405451325451,
                5710643921839718407,
                5701700996770562062,
                5375265804189189595,
                5632207511093248010,
                5604922468625023009,
                5717737768998666247,
                5762366696861990930,
                5492319666053316633,
                5591366035715391496,
                5553353530741358598,
                5517233362588139530,
                5539514394494369805,
                5523913514202169364,
                5015142455801022324,
                5472001223747979823,
                5460968041175074217,
                5224698157895534565,
                5217614378139924936,
                5208944110479622965,
                5445266293575927895,
                5388822924293588409,
                5334946326251586946,
                5312489303765430099,
                5271956091075313012,
                5460834880009026589,
                5188249592247890215,
                5361746423962418712,
                5046759574082683669,
                5332333439947394970,
                5273737978517145694,
                5426964153732449060,
                5420623295944868630,
                5287761837012568140,
                5366446707322145801,
                5201721036344679215,
                5402111321179179380,
                5269773341450836434,
                5326016612501836502,
                5222151164979599382,
                5303467072125163514,
                5215680603474645577,
                5260603586273894516,
                5197403451750896580,
                5363880842319911945,
                5350689172392795613,
                5364218894900807959,
                5267178992225504675,
                5467687234041826545,
                5219754285465606022,
                5215176077961350523,
                5289615987279157811,
                5229000529715153707,
                5472309439191073890,
                5436257041326821148,
                5301114984825118615,
                5235844027525386142,
                5312041836892675953,
                5233365986014420963,
                5276140329819460862,
                5393236217938594247,
                5282985717415304019,
                5474173394867998524,
                5429411250004055645,
                5235529983811670976,
                5258154033280995408,
                5354967385021371738,
                5188562390421098380,
                5339558640091156104,
                5202121275757050228,
                5280958939528187494,
                5409357837245630745,
                5427195935937549570,
                5474460702410294911,
                5278403077504782598,
                5408957297185542626,
                5233503459327626386,
                5204413731731160980,
                5210988154135261581,
                5330331572870599180,
                5328171900105405553,
                5282957555314728059,
                5219882692102867066,
                5203973364439337911,
                5202157903238141805,
                5424589118422145723,
                5271946539068037852,
                5362081989757255882,
                5496856860914876428,
                5334624873719273642,
                5310138204307868219,
                5287354467954477553,
                5319177637292160119,
                5220005468037993227,
                5427182947956440499,
                5305669114742722915,
                5289543780288971412,
                5305750439948465683,
                5389104167342063261,
                5449359010861956820,
                5289817034698267624,
                5300800846622104011,
                5215311356546263053,
                5431617471624798325,
                5460665984715081728,
                5224652296234735777,
                5307726648890638696,
                5282819764173936427,
                5197405109608275562,
                5215253864114045785,
                5296605728725800932,
                5231253094033004867,
                5213192219682426206,
                5411507829154531475,
                5309785694867043246,
                5402349567310053720,
                5292150503315095993,
                5420231728071459313,
                5301183708596818801,
                5289594705716203466,
                5334945003401654009,
                5316933933491836474,
                5420543465387743692,
                5323481379206339475,
                5271572997172370296,
                5264778882896108916,
                5366350641788638575,
                5393299396907520375,
                5409171852276813755,
                5308028460537503574,
                5402246376425804992,
                5372890936382608427,
                5260346463761747746,
                5303293422302425285,
                5269466010771018176,
                5280772555127409384,
                5201965948264781569,
                5229016601482776567,
                5278468090424743557,
                5449502020388016318,
                5445159022472746552,
                5355096272694951726,
                5303031197369126799,
                5278549175112324076,
                5240195692684658955,
                5386405300087569470,
                5438153630165257316,
                5246706837335584772,
                5381818360914791298,
                5305606339500716666,
                5296477528246983373,
                5208669928357382382,
                5300931044260727537,
                5325673178326908685,
                5332696038266379096,
                5402091482725240276,
                5332534946928016204,
                5199801190258317413,
                5235815680741232979,
                5305461758016635527,
                5462909529601623814,
                5454306267726107102,
                5361647407786378862,
                5229123365779828990,
                5319040082374575127,
                5404541362135644327,
                5427053755340182171,
                5384340838157406314,
                5465575244003556617,
                5359398631629675162,
                5416090885676875994,
                5469915548974336625,
                5215527195832756800,
                5275989945834557503,
                5415640712974714131,
                5454328103339839002,
                5343933807311467091,
                5611588150494232592,
                5260350432311529401,
                5343724431950756749,
                5386841114714061509,
                5260557131907609234,
                5276514434355830294,
                4913682971648590332,
                5323426412214885817,
                5402349644619468753,
                5217786211191511814,
                5330524060419897725,
                5402405234381177473,
                5334911489771844419,
                5386862675449899143,
                5449440821399012582,
                5211060335355638741,
                5253748075440129301,
                5197520025753246919,
                5321011313449655360,
                5201756151997284775,
                5213394740275331738,
                5285436760761840834,
                5264801010567626868,
                5454018882874391666,
                5278542045466612245,
                5220134192502819741,
                5330199652950096023,
                5206579593544219932,
                5202005612287779106,
                5316623557680185598,
                5199421747077584990,
                5323480984069358714,
                5287295781521344331,
                5231170673610595275,
                5199509218381535721,
                5309864361488034390,
                5226751457205688851,
                5301278678913652950,
                5265221702614260055,
                5276520408655338097,
                5310277047715639372,
                5309929151069698755,
                5228929701409462851,
                5202082225914385660,
                5231212347678275914,
                5289629915858094188,
                5267332996867831343,
                5193180395092330134,
                5418181894799899680,
                5359574712403906605,
                5307718097610754754,
                5220089383109016312,
                5201687174822510819,
                5113957245121463396,
                5314503351369472346,
                4954250363688453518,
                5206341557866738444,
                5474141375886803172,
                4967478970334315349,
                5359819272136702255,
                5429503093584708815,
                5226758075750306754,
                5317021413385714861,
                5388652560120825927,
                5267129694590874705,
                5442946238141968338,
                5222469924567402209,
                5467638615012029622,
                5458469658698988745,
                5330482850208691087,
                5316716367628480549,
                5420507486446700198,
                5334902547649933407,
                5368723830263007662,
                5283233863445792731,
                5235665880871875633,
                5242522100375237015,
                5361611003643575178,
                5319069369756564474,
                5303040994189515406,
                5303274812209110229,
            ]

        return random.choice(list_id_effect)
